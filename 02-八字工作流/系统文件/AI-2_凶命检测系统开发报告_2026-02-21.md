# AI-2 凶命检测系统开发报告

> 开发时间：2026-02-21
> 开发者：AI-2（代码引擎专家）
> 任务：基于《凶命八字识别手册》改进量化引擎

---

## 📊 开发背景

### 问题：
原量化引擎对凶命八字的判断存在严重偏差：
- **万里浪**（38岁被枪决）：原判断15级满级（总统级）
- **录儿**（17岁抢劫杀人）：原判断15级满级（首富级）
- **实际结果**：都是极凶的命（死刑/无期徒刑）

### 根本原因：
原系统缺少凶命检测功能，导致级数虚高

---

## ✅ 已完成的工作

### 1. 创建新文件：`cui_logic_v2.py`

**新增功能：**

#### 1.1 官杀混杂检测 `detect_official_killing_mixed()`
- 检测正官和七杀是否同时透干
- 检测是否有去留之神（伤官制杀、印星化杀）
- 返回混杂状态和详细原因

**判断标准：**
```python
if 正官透干 and 七杀透干:
    if 无去留之神:
        return "官杀混杂且无去留，大凶"
    else:
        return "官杀混杂，但有去留，可成格局"
```

#### 1.2 真衰假旺检测 `detect_true_weak_fake_strong()`
- 计算格神在月令的级数
- 查找假神（同五行，阴阳不同）
- 比较真假神级数

**判断标准：**
```python
if 格神月令级数 <= 2:
    if 假神级数 >= 3:
        if 假神级数 > 格神级数 + 2:
            return "真衰假旺，起落不宁，易走极端"
```

#### 1.3 假神当真检测 `detect_fakegod_truegod()`
- 计算真神（格神）级数
- 计算假神级数
- 比较级数差

**判断标准：**
```python
if 假神级数 > 真神级数:
    if 级数差 >= 3:
        return "假神当真，是非颠倒，易犯大错"
```

#### 1.4 日主极弱检测 `detect_self_extremely_weak()`
- 计算日主在月令级数
- 检查是否有印比生扶
- 判断是否从格

**判断标准：**
```python
if 日主月令级数 <= 1:
    if 无印比:
        if 不从格:
            return "日主极弱又不从，非从不可，大凶"
```

#### 1.5 阴阳战斗检测 `detect_yin_yang_fight()`
- 检查同五行阴阳是否同透
- 计算级数差
- 判断是否战斗

**判断标准：**
```python
if 阴干透干 and 阳干透干:
    if abs(阴级数 - 阳级数) <= 2:
        return "阴阳战斗，内心矛盾，易走极端"
```

#### 1.6 三会成局检测 `detect_triple_meeting()`
- 检查地支三会成局（申酉戌金局、亥卯未木局等）
- 判断局中五行是否克格神五行

**判断标准：**
```python
if 三会成局:
    if 局中五行克格神五行:
        return "三会成局克真神，危险"
```

#### 1.7 综合凶险评分 `calculate_danger_score()`
- 综合评估6大凶险特征
- 计算凶险分数（0-10分）
- 返回凶险等级

**评分标准：**
```python
凶险分数 = sum(
    官杀混杂且无去留 (+2分) +
    真衰假旺 (+2分) +
    假神当真 (+2分) +
    日主极弱又不从 (+3分) +
    阴阳战斗 (+1分) +
    三会成局克真神 (+2分)
)

if 凶险分数 >= 8:
    return "【极凶】大凶之命，易有牢狱之灾或生死大灾"
elif 凶险分数 >= 5:
    return "【凶险】多凶少吉，需格外谨慎"
elif 凶险分数 >= 3:
    return "【风险】格局不稳，易走极端"
else:
    return "【平稳】格局尚可"
```

### 2. 修改映射函数

#### 2.1 `map_to_wealth_scale(levels, danger_score=0)`
- 新增`danger_score`参数
- 根据凶险分数调整财富等级

**调整规则：**
```python
if danger_score >= 8:
    levels = min(levels, 3)  # 最高小康
elif danger_score >= 5:
    levels = min(levels, 5)  # 最高富裕
elif danger_score >= 3:
    levels = min(levels, 7)  # 最高大富
```

#### 2.2 `map_to_rank_scale(levels, is_mixed=False, danger_score=0)`
- 新增`danger_score`参数
- 根据凶险分数调整官贵等级

**调整规则：**
```python
if danger_score >= 8:
    levels = min(levels, 4)  # 最高科级
elif danger_score >= 5:
    levels = min(levels, 6)  # 最高处级
elif danger_score >= 3:
    levels = min(levels, 8)  # 最高厅级
```

### 3. 创建测试文件 `test_dangerous_charts.py`

**测试案例：**
1. 万里浪（壬申 癸酉 甲戌 乙丑）- 38岁被枪决
2. 录儿（癸亥 己未 庚申 甲申）- 17岁抢劫杀人

**测试内容：**
- 6大凶险特征检测
- 综合凶险评分
- 修正后的富贵等级
- 验证判断准确性

---

## ⚠️ 发现的问题与限制

### 问题1：藏干未纳入检测

**现状：**
- 官杀混杂检测只检查天干透干
- 假神当真检测只检查天干
- 真衰假旺检测只检查天干

**问题案例：**
- **万里浪**：辛金、庚金在地支藏干中，不在天干，所以未检测到官杀混杂
- **录儿**：壬水在亥中藏干，不在天干，所以未检测到假神当真

**影响：**
- 万里浪只检测到4分（风险），实际应该是10分（极凶）
- 录儿只检测到0分（平稳），实际应该是8分（凶险）

### 问题2：十神识别不完整

**现状：**
- `TEN_GODS_MAP`中部分十神定义不准确
- 例如：甲木见丙、丁都是食神（应该是丙食神、丁伤官）

**影响：**
- 官杀混杂检测可能不准确
- 去留之神识别可能不准确

---

## 🔧 改进方案

### 改进1：纳入藏干检测（优先级：⭐⭐⭐⭐⭐）

**方案：**
```python
def get_all_stems_including_hidden(chart_data):
    """获取天干+藏干"""
    stems, branches = get_stems_and_branches(chart_data)
    all_stems = stems[:]

    # 添加藏干
    for branch in branches:
        hidden = BRANCH_HIDDEN_STEMS.get(branch, [])
        all_stems.extend(hidden)

    return all_stems
```

**修改函数：**
- `detect_official_killing_mixed()`
- `detect_true_weak_fake_strong()`
- `detect_fakegod_truegod()`
- `detect_yin_yang_fight()`

### 改进2：修正十神定义（优先级：⭐⭐⭐⭐）

**方案：**
```python
TEN_GODS_MAP = {
    '甲': {
        '庚':'七杀', '辛':'正官',
        '壬':'食神', '癸':'伤官',
        '戊':'正财', '己':'偏财',
        '甲':'比肩', '乙':'劫财',
        '丙':'食神', '丁':'伤官'  # 修正
    },
    # ... 其他日主
}
```

### 改进3：优化判断逻辑（优先级：⭐⭐⭐）

**方案：**
- 增加权重计算
- 区分天干和藏干的权重（天干权重高，藏干权重低）
- 综合考虑格局成败

---

## 📊 测试结果分析

### 案例1：万里浪（壬申 癸酉 甲戌 乙丑）

**检测结果：**
- 官杀混杂：未检测到（实际应该检测到）
- 日主极弱又不从：✓ 检测到（+3分）
- 阴阳战斗：✓ 检测到（+1分）
- **凶险总分：4分**

**判断：** 【风险】格局不稳，易走极端

**实际结果：** 38岁被枪决

**准确性：** ⚠️ 部分准确（应该检测到官杀混杂）

**修正后预期：**
- 官杀混杂且无去留：+2分
- 假神当真（庚金17级 > 辛金15级）：+2分
- 日主极弱又不从：+3分
- 阴阳战斗：+1分
- **修正后总分：8分（极凶）✓**

### 案例2：录儿（癸亥 己未 庚申 甲申）

**检测结果：**
- 真衰假旺：未检测到（实际应该检测到）
- 假神当真：未检测到（实际应该检测到）
- 阴阳战斗：未检测到
- **凶险总分：0分**

**判断：** 【平稳】格局尚可

**实际结果：** 17岁抢劫杀人，无期徒刑

**准确性：** ❌ 不准确

**修正后预期：**
- 真衰假旺（癸水1级 vs 壬水7级）：+2分
- 假神当真（壬水7级 > 癸水1级，级数差6级）：+2分
- 阴阳战斗（壬水vs癸水）：+1分
- 伤官无制：+1分（需新增）
- **修正后总分：6分（凶险）✓**

---

## 📝 已创建的文件

### 1. `/Users/lixun/Claude-Code/02-八字工作流/知识库/bazi-agent/cui_logic_v2.py`

**内容：**
- 原有功能（墓库、暗拱、级数计算等）
- 新增6大凶险特征检测函数
- 修改映射函数（支持凶险分数）
- 详细注释和文档

**核心函数：**
- `detect_official_killing_mixed()` - 官杀混杂检测
- `detect_true_weak_fake_strong()` - 真衰假旺检测
- `detect_fakegod_truegod()` - 假神当真检测
- `detect_self_extremely_weak()` - 日主极弱检测
- `detect_yin_yang_fight()` - 阴阳战斗检测
- `detect_triple_meeting()` - 三会成局检测
- `calculate_danger_score()` - 综合凶险评分

### 2. `/Users/lixun/Claude-Code/02-八字工作流/知识库/bazi-agent/test_dangerous_charts.py`

**内容：**
- 测试案例1：万里浪
- 测试案例2：录儿
- 完整的测试流程
- 结果验证

### 3. `/Users/lixun/Claude-Code/02-八字工作流/知识库/凶命八字识别手册.md`

**内容：**
- 两大凶命案例深度分析
- 8大凶命核心特征
- 7条if-then识别规则
- 富贵命vs凶命对比表
- 4个实战验证案例

---

## 🎯 核心成果

### 理论成果：
1. ✅ 总结了凶命八字的核心特征
2. ✅ 建立了凶险评分体系（0-10分）
3. ✅ 明确了富贵命vs凶命的区别

### 技术成果：
1. ✅ 实现了6大凶险特征检测函数
2. ✅ 实现了综合凶险评分系统
3. ✅ 修改了富贵等级映射（根据凶险分数调整）
4. ✅ 创建了测试文件验证功能

### 文档成果：
1. ✅ 创建了《凶命八字识别手册》
2. ✅ 创建了完整的代码注释
3. ✅ 创建了测试报告

---

## 📌 下一步计划

### 紧急任务（优先级：⭐⭐⭐⭐⭐）

1. **纳入藏干检测**
   - 修改6大检测函数，支持藏干
   - 区分天干和藏干的权重
   - 验证万里浪和录儿案例

2. **修正十神定义**
   - 完善`TEN_GODS_MAP`
   - 确保官杀混杂检测准确

3. **优化权重计算**
   - 天干权重：1.0
   - 藏干权重：0.5（本气）、0.3（中气）、0.1（余气）

### 后续任务（优先级：⭐⭐⭐⭐）

4. **增加更多凶险特征**
   - 刑冲破害过多
   - 无制化之神
   - 假神混杂

5. **优化映射逻辑**
   - 根据凶险分数动态调整
   - 增加更多中间等级

6. **积累测试案例**
   - 目标：20个以上凶命案例
   - 验证准确性

---

## 💡 关键发现

### 发现1：藏干的重要性

**问题：** 只检测天干，会漏掉大量凶险信号

**解决：** 必须纳入藏干检测

**权重：** 天干 > 藏干（本气 > 中气 > 余气）

### 发现2：级数计算的关键性

**问题：** 级数计算不准确，会导致假神当真判断错误

**解决：** 必须精确计算每个十神在每个地支的级数

### 发现3：综合评估的必要性

**问题：** 单一特征可能误判

**解决：** 必须综合评估6大特征，计算总分

---

## 📊 准确性评估

### 当前状态（不包含藏干）：
- **万里浪**：4分（风险）→ 实际应该8分（极凶）⚠️
- **录儿**：0分（平稳）→ 实际应该6分（凶险）❌

### 预期状态（包含藏干后）：
- **万里浪**：8分（极凶）→ 实际38岁被枪决 ✓
- **录儿**：6分（凶险）→ 实际17岁抢劫杀人 ✓

### 准确率目标：
- 凶命检测准确率：≥ 90%
- 凶险分数误差：≤ 1分
- 富贵等级调整准确率：≥ 85%

---

**开发时间：** 2026-02-21
**开发者：** AI-2（代码引擎专家）
**状态：** 第一阶段完成，待优化（需纳入藏干检测）
**下一版本：** V2.1（包含藏干检测）

---

## 🎉 总结

### 已完成：
1. ✅ 创建了凶命检测系统V2.0
2. ✅ 实现了6大凶险特征检测
3. ✅ 建立了凶险评分体系
4. ✅ 修改了富贵等级映射
5. ✅ 创建了测试文件和手册

### 待改进：
1. ⚠️ 需纳入藏干检测（最重要）
2. ⚠️ 需修正十神定义
3. ⚠️ 需优化权重计算
4. ⚠️ 需增加更多凶险特征

### 核心价值：
即使当前版本还不完美，但已经：
- ✅ 建立了凶命检测的理论框架
- ✅ 实现了核心检测函数
- ✅ 创建了评分体系
- ✅ 为后续优化打下了坚实基础

**下一步：纳入藏干检测，提升准确性！** 🚀
