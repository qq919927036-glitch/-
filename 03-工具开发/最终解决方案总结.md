# Antigravity 502 Bad Gateway - 完整诊断和解决方案

## 🔍 问题总结

你遇到的 **502 Bad Gateway** 错误是一个复杂的网络代理拦截问题，涉及多个层面：

### 问题层级（从底层到上层）

```
┌─────────────────────────────────────────┐
│  1️⃣ 网络层: Clash Verge TUN 模式         │  ← 系统级流量拦截
│     - 虚拟网卡: utun1024                 │
│     - 拦截所有网络流量                   │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│  2️⃣ 浏览器内: ZeroOmega 扩展            │  ← 浏览器级流量拦截
│     - Chrome 扩展                        │
│     - 劫持浏览器网络请求                 │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│  3️⃣ 应用层: Antigravity                 │
│     - 尝试通过 CDP 控制 Chrome          │
│     - 访问外部网站（如推特）             │
│     - 遇到 502 错误                      │
└─────────────────────────────────────────┘
```

---

## ✅ 已完成的修复

### 1. Clash Verge TUN 模式配置 ✅

**修改文件**: `~/Library/Application Support/io.github.clash-verge-rev.clash-verge-rev/clash-verge.yaml`

**修改内容**:
```yaml
tun:
  route-exclude-address:
  - 0.0.0.0/32
  - 192.168.0.0/16
  - 10.0.0.0/8
  - 172.16.0.0/12
  - 127.0.0.0/8        # ⭐ 关键：排除本地回环
  - 224.0.0.0/4
  - 255.255.255.255/32
```

**状态**: ✅ 已配置并生效

---

### 2. ZeroOmega 扩展处理 ✅

**操作**: 禁用所有 Antigravity 配置文件中的 ZeroOmega 扩展

**状态**: ✅ 已禁用

---

### 3. 系统代理配置 ✅

**操作**: 设置 NO_PROXY 环境变量

```bash
export NO_PROXY="localhost,127.0.0.1,::1"
```

**状态**: ✅ 已配置（永久）

---

## 📊 当前环境状态

### 正面状态 ✅

- ✅ Clash Verge TUN 排除规则已配置（127.0.0.0/8）
- ✅ ZeroOmega 扩展已禁用
- ✅ NO_PROXY 环境变量已设置
- ✅ Antigravity 正在运行
- ✅ Chrome 配置文件干净

### 风险因素 ⚠️

- ⚠️  Clash Verge TUN 模式仍在运行（可能影响某些请求）
- ⚠️  系统代理仍在启用（HTTP_PROXY=http://127.0.0.1:7897）
- ⚠️  多个 Antigravity 浏览器配置文件存在

---

## 🧪 测试步骤

### 步骤 1: 启动实时监控

```bash
bash /Users/lixun/Claude-Code/05-临时任务/monitor_antigravity.sh
```

### 步骤 2: 在 Antigravity 中触发浏览器操作

- "打开推特"
- "搜索今天天气"
- 或任何浏览器自动化任务

### 步骤 3: 观察监控输出

监控脚本会显示：
- Chrome 进程信息
- CDP 端点状态
- 网络连接测试
- 可能的错误原因

---

## 🔧 如果仍然失败

### 方案 1: 临时关闭 Clash TUN 模式

**最简单的测试方法**:

1. 打开 Clash Verge
2. 关闭『TUN 模式』开关
3. 在 Antigravity 中重新测试
4. 如果成功，确认是 TUN 模式的问题

### 方案 2: 完全重置环境

```bash
# 关闭所有相关进程
killall 'Google Chrome' 'Antigravity' 2>/dev/null

# 重启 Antigravity
open -a "Antigravity"

# 重新测试
```

### 方案 3: 使用系统代理模式（替代 TUN）

1. 关闭 Clash TUN 模式
2. 启用 Clash 系统代理模式
3. 配置系统代理绕过：
   - `localhost`
   - `127.0.0.1`
   - `*.local`

### 方案 4: 诊断详细问题

```bash
# 运行诊断脚本
bash /Users/lixun/Claude-Code/05-临时任务/diagnose_502.sh

# 查看实时日志
tail -f ~/.gemini/antigravity/logs/*.log
```

---

## 📁 可用工具

| 工具 | 命令 | 用途 |
|------|------|------|
| 实时监控 | `bash /Users/lixun/Claude-Code/05-临时任务/monitor_antigravity.sh` | 监控 Chrome 启动 |
| 环境验证 | `bash /Users/lixun/Claude-Code/05-临时任务/verify_antigravity.sh` | 验证当前状态 |
| 完全重置 | `bash /Users/lixun/Claude-Code/05-临时任务/reset_for_antigravity.sh` | 重置环境 |
| 问题诊断 | `bash /Users/lixun/Claude-Code/05-临时任务/diagnose_502.sh` | 诊断 502 错误 |
| 干净浏览器 | `bash /Users/lixun/Claude-Code/05-临时任务/create_clean_browser.sh` | 创建无代理浏览器 |

---

## 🎯 最可能的原因

根据我们的诊断，**502 错误最可能的原因**是：

### Clash TUN 模式仍然拦截了某些请求

虽然我们配置了 `127.0.0.0/8` 的排除规则，但：
1. TUN 模式可能在某些情况下不遵守排除规则
2. Antigravity 访问外部网站时，流量仍被 TUN 拦截
3. 代理服务器无法正确处理这些请求，返回 502

**验证方法**:
```bash
# 临时关闭 TUN 模式
# 然后在 Antigravity 中测试
```

---

## 📝 技术细节

### TUN 模式如何工作？

```
正常流程:
应用 → 网卡 → 路由 → 互联网

TUN 模式:
应用 → TUN 虚拟网卡 → Clash → 代理服务器 → 互联网
         ↑
    拦截所有流量
```

### 配置排除规则后

```
应用 → 判断目标地址
         ↓
    是否在排除列表？
         ↓
    是 → 直接连接（绕过 TUN）✅
    否 → 通过 TUN → Clash → 代理 ✅
```

### 为什么可能仍然失败？

1. **排除规则未完全生效**
   - Clash 需要重启才能应用新规则
   - 某些情况下规则可能不生效

2. **DNS 查询被拦截**
   - TUN 模式也会拦截 DNS
   - 即使配置了排除规则，DNS 可能仍走代理

3. **Chrome 的网络栈**
   - Chrome 可能有多个网络请求
   - 某些请求可能不走预期的路由

---

## ✨ 推荐方案

**如果上述方案都无效，推荐使用方案 1**：

**临时关闭 Clash TUN 模式进行测试**

这是最直接、最有效的验证方法。如果关闭 TUN 后 Antigravity 可以正常工作，就说明问题确实出在 TUN 模式上。

然后你可以：
1. 选择永久关闭 TUN 模式（使用系统代理模式替代）
2. 或者深入调试 Clash 配置，找到更精确的排除规则

---

## 📞 需要进一步帮助？

如果以上方案都无法解决问题，请提供以下信息：

1. **监控脚本输出**（运行 monitor_antigravity.sh）
2. **详细错误信息**（Antigravity 的完整错误消息）
3. **Clash 日志**（如果有）
4. **Antigravity 日志**（`~/.gemini/antigravity/logs/`）

这样我可以进行更深入的诊断。

---

**文档版本**: v1.0
**最后更新**: 2026-02-16
**状态**: 等待用户测试反馈
